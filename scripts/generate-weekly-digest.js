#!/usr/bin/env node
/**
 * Weekly Digest Generator
 * Synthesizes data from all sources into a readable summary
 * 
 * Output: markdown summary of the week's AI coding tool news
 */

const fs = require('fs');
const path = require('path');

const DATA_DIR = path.join(__dirname, '..', 'data');
const OUTPUT_DIR = path.join(__dirname, '..', 'site', 'digests');

// Ensure output directory exists
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

function loadJson(filename) {
  const filepath = path.join(DATA_DIR, filename);
  if (!fs.existsSync(filepath)) return null;
  return JSON.parse(fs.readFileSync(filepath, 'utf8'));
}

function formatDate(dateStr) {
  if (!dateStr) return 'Unknown';
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function getWeekDates() {
  const now = new Date();
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  return { start: weekAgo, end: now };
}

function isThisWeek(dateStr) {
  if (!dateStr) return false;
  const { start, end } = getWeekDates();
  const date = new Date(dateStr);
  return date >= start && date <= end;
}

function generateDigest() {
  const digest = [];
  const { start, end } = getWeekDates();
  
  const weekStr = `${formatDate(start)} - ${formatDate(end)}`;
  
  digest.push(`# AI Coding Tools Weekly Digest`);
  digest.push(`**Week of ${weekStr}**\n`);
  digest.push(`*Generated by [Briefing](https://kell.cx) â€” competitive intelligence for AI coding tools*\n`);
  digest.push('---\n');

  // 1. GitHub Releases
  const releases = loadJson('github-releases.json');
  if (releases?.recentReleases) {
    const weeklyReleases = releases.recentReleases.filter(r => isThisWeek(r.publishedAt));
    
    if (weeklyReleases.length > 0) {
      digest.push('## ðŸš€ New Releases\n');
      weeklyReleases.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
      // Group by repo, show latest per repo to avoid spam
      const seenRepos = new Set();
      const dedupedReleases = weeklyReleases.filter(r => {
        if (seenRepos.has(r.repo)) return false;
        seenRepos.add(r.repo);
        return true;
      });
      dedupedReleases.slice(0, 12).forEach(r => {
        digest.push(`- **${r.company || r.repo}** [${r.tag}](${r.url}) â€” ${formatDate(r.publishedAt)}`);
      });
      digest.push('');
    }
  }

  // 2. Company Announcements
  const announcements = loadJson('company-announcements.json');
  if (announcements?.companies) {
    const weeklyPosts = [];
    announcements.companies.forEach(company => {
      if (company.posts) {
        company.posts.filter(p => isThisWeek(p.date)).forEach(p => {
          weeklyPosts.push({
            company: company.company,
            logo: company.logo,
            ...p
          });
        });
      }
    });
    
    if (weeklyPosts.length > 0) {
      digest.push('## ðŸ“¢ Company Announcements\n');
      weeklyPosts.sort((a, b) => new Date(b.date) - new Date(a.date));
      weeklyPosts.slice(0, 15).forEach(p => {
        const desc = p.description ? ` â€” ${p.description.slice(0, 100)}${p.description.length > 100 ? '...' : ''}` : '';
        digest.push(`- ${p.logo} **${p.company}**: [${p.title}](${p.link})${desc}`);
      });
      digest.push('');
    }
  }

  // 3. AI RSS News
  const rssNews = loadJson('ai-rss-news.json');
  if (rssNews?.items) {
    const weeklyNews = rssNews.items.filter(item => isThisWeek(item.pubDate));
    if (weeklyNews.length > 0) {
      digest.push('## ðŸ“° Industry News\n');
      weeklyNews.slice(0, 10).forEach(item => {
        digest.push(`- [${item.title}](${item.link}) (${item.source})`);
      });
      digest.push('');
    }
  }

  // 4. Hacker News Mentions
  const hnData = loadJson('hn-ai-mentions.json');
  if (hnData?.stories && Array.isArray(hnData.stories)) {
    const weeklyStories = hnData.stories.filter(s => isThisWeek(s.createdAt));
    
    if (weeklyStories.length > 0) {
      digest.push('## ðŸ’¬ Hacker News Discussions\n');
      // Sort by points
      weeklyStories.sort((a, b) => (b.points || 0) - (a.points || 0));
      weeklyStories.slice(0, 10).forEach(s => {
        const topic = s.matchedQuery ? ` (${s.matchedQuery})` : '';
        digest.push(`- [${s.title}](${s.hnUrl}) â€” ${s.points || 0} points, ${s.comments || 0} comments${topic}`);
      });
      digest.push('');
    }
  }

  // 5. Benchmark Updates
  const sweBench = loadJson('swe-bench.json');
  const aiderBench = loadJson('aider-benchmark.json');
  
  const benchmarkHighlights = [];
  
  if (sweBench?.verified?.length > 0) {
    const top3 = sweBench.verified.slice(0, 3);
    benchmarkHighlights.push('**SWE-bench Verified Top 3:**');
    top3.forEach((entry, i) => {
      benchmarkHighlights.push(`  ${i + 1}. ${entry.name} â€” ${entry.resolved_pct?.toFixed(1)}%`);
    });
  }
  
  if (aiderBench?.leaderboard?.length > 0) {
    const top3 = aiderBench.leaderboard.slice(0, 3);
    benchmarkHighlights.push('**Aider Polyglot Top 3:**');
    top3.forEach((entry, i) => {
      benchmarkHighlights.push(`  ${i + 1}. ${entry.model} â€” ${entry.score}% ($${entry.cost?.toFixed(2) || '?'})`);
    });
  }
  
  if (benchmarkHighlights.length > 0) {
    digest.push('## ðŸ“Š Benchmark Standings\n');
    digest.push(benchmarkHighlights.join('\n'));
    digest.push('');
  }

  // 6. Pricing Changes (compare with stored history if available)
  const pricing = loadJson('pricing.json');
  if (pricing?.categories) {
    digest.push('## ðŸ’° Pricing Snapshot\n');
    digest.push('Quick reference for individual pricing:\n');
    pricing.categories.forEach(cat => {
      const tools = cat.tools.filter(t => t.individual?.price && typeof t.individual.price === 'number');
      if (tools.length > 0) {
        const sorted = tools.sort((a, b) => a.individual.price - b.individual.price);
        digest.push(`**${cat.name}**: ${sorted.map(t => `${t.name} $${t.individual.price}/${t.individual.period}`).join(' â€¢ ')}`);
      }
    });
    digest.push('');
  }

  // Footer
  digest.push('---\n');
  digest.push(`*Updated: ${new Date().toISOString()}*\n`);
  digest.push(`*Data sources: GitHub, Hacker News, RSS feeds, company blogs*\n`);
  digest.push(`*Subscribe at [kell.cx](https://kell.cx) for daily updates*`);

  return digest.join('\n');
}

// Generate and save
const digestContent = generateDigest();
const dateStr = new Date().toISOString().split('T')[0];
const outputFile = path.join(OUTPUT_DIR, `digest-${dateStr}.md`);

fs.writeFileSync(outputFile, digestContent);
console.log(`Generated digest: ${outputFile}`);

// Also output to stdout
console.log('\n--- DIGEST PREVIEW ---\n');
console.log(digestContent);
